<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¢¨éŸµæ™ºå¸ˆï¼šç¡¬ç¬”ä¹¦æ³•è¯„ä¼°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        #canvasContainer {
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        /* æŒ‰é’®äº¤äº’æ•ˆæœ */
        .btn-hover:hover { transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .btn-hover:active { transform: translateY(1px); box-shadow: none; }
    </style>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.firebase = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, getFirestore, doc, setDoc, onSnapshot };
    </script>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-2xl p-6">
        
        <!-- é¡¶éƒ¨æ ‡é¢˜ -->
        <header class="mb-6 border-b pb-4 flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-extrabold text-indigo-700">å¢¨éŸµæ™ºå¸ˆï¼šç¡¬ç¬”ä¹¦æ³•è¯„ä¼°</h1>
                <p class="text-sm text-gray-500 mt-1">ä¸Šä¼ ç…§ç‰‡ -> å¯¹é½èŒƒå­— -> AI é£æ ¼è¯„ä¼°</p>
            </div>
            <div id="status-box" class="text-sm font-medium text-gray-600 bg-gray-100 px-3 py-1 rounded">
                çŠ¶æ€: å‡†å¤‡å°±ç»ª
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- å·¦ä¾§æ§åˆ¶åŒº -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- æ ¸å¿ƒæŒ‰é’®ç»„ -->
                <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100 space-y-3">
                    <h3 class="font-bold text-indigo-800">1. å›¾ç‰‡æ“ä½œ</h3>
                    <div class="flex flex-col gap-3">
                        <!-- ä¸Šä¼ æŒ‰é’® -->
                        <button id="upload-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg btn-hover flex items-center justify-center cursor-pointer">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                            ä¸Šä¼ ç”¨æˆ·ç…§ç‰‡
                        </button>
                        <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† -->
                        <input type="file" id="image-upload" accept="image/png, image/jpeg" style="display: none;">
                        
                        <!-- AI è‡ªåŠ¨å¯¹é½æŒ‰é’® (æ–°å¢) -->
                        <button id="auto-align-btn" class="w-full bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg btn-hover flex items-center justify-center cursor-pointer">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            ğŸ¯ AI è‡ªåŠ¨å¯¹é½
                        </button>

                        <div class="flex gap-2">
                            <button id="reset-btn" class="flex-1 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg btn-hover text-sm">
                                é‡ç½®å¯¹é½
                            </button>
                            <button id="save-btn" class="flex-1 bg-green-600 text-white font-bold py-2 px-4 rounded-lg btn-hover text-sm">
                                ä¿å­˜è¿›åº¦
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-purple-50 p-4 rounded-lg border border-purple-100 space-y-3">
                    <h3 class="font-bold text-purple-800">2. è¯„ä¼°é…ç½®</h3>
                    <div>
                        <label class="block text-sm text-gray-700 mb-1">ç›®æ ‡æ–‡å­—</label>
                        <input type="text" id="target-char" value="æ°¸" class="w-full border rounded p-2" maxlength="1">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-700 mb-2">é€‰æ‹©è¯„åˆ¤é£æ ¼ (å¯å¤šé€‰)</label>
                        <div class="space-y-2">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" class="style-checkbox form-checkbox text-purple-600" value="ç”°è‹±ç« ç¡¬ç¬”æ¥·ä¹¦" checked>
                                <span>ç”°è‹±ç« ç¡¬ç¬”æ¥·ä¹¦</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" class="style-checkbox form-checkbox text-purple-600" value="å¢ä¸­å—ç¡¬ç¬”æ¥·ä¹¦">
                                <span>å¢ä¸­å—ç¡¬ç¬”æ¥·ä¹¦</span>
                            </label>
                        </div>
                    </div>
                    <button id="evaluate-btn" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg btn-hover mt-2">
                        âœ¨ ç”Ÿæˆè¯„ä¼°æŠ¥å‘Š
                    </button>
                </div>
                
                <!-- å˜æ¢æ•°æ®å±•ç¤º -->
                <div class="bg-gray-800 text-gray-300 p-3 rounded text-xs font-mono">
                    <div class="flex justify-between mb-1">
                        <span class="text-yellow-400">Transform Data</span>
                        <button id="copy-data-btn" class="text-blue-400 hover:text-blue-300">å¤åˆ¶</button>
                    </div>
                    <div id="transform-debug">Scale: 1.0, X: 0, Y: 0</div>
                </div>
            </div>

            <!-- ä¸­é—´ç”»å¸ƒåŒº -->
            <div class="lg:col-span-2 space-y-4">
                <div id="canvasContainer" class="relative w-full aspect-square bg-gray-100 cursor-move border-2 border-dashed border-gray-300">
                    <canvas id="mainCanvas" class="w-full h-full block"></canvas>
                    
                    <!-- è¦†ç›–å±‚æç¤º -->
                    <div id="overlay-msg" class="absolute inset-0 flex flex-col items-center justify-center text-gray-500 pointer-events-none">
                        <svg class="w-12 h-12 mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <p>è¯·ç‚¹å‡»å·¦ä¾§â€œä¸Šä¼ ç”¨æˆ·ç…§ç‰‡â€</p>
                    </div>
                </div>

                <!-- è¯„ä¼°ç»“æœåŒº -->
                <div id="report-area" class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm hidden">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">AI è¯„ä¼°æŠ¥å‘Š</h3>
                    <div id="report-content" class="prose max-w-none text-gray-700 space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

<script>
    // ================= é…ç½® =================
    const API_KEY = ""; // è¿è¡Œæ—¶è‡ªåŠ¨å¡«å……
    const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
    
    // èŒƒå­— (ç»¿è‰²) SVG
    const EXEMPLAR_SVG_SRC = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(`
    <svg width="1000" height="1000" xmlns="http://www.w3.org/2000/svg">
        <g transform="translate(100,100) scale(0.8)" fill="rgba(0,200,0,0.6)">
            <path d="M500 150 Q550 100 600 150 T650 200" />
            <path d="M550 250 L800 250" stroke="rgba(0,200,0,0.6)" stroke-width="40" stroke-linecap="round" fill="none"/>
            <path d="M500 200 L500 800" stroke="rgba(0,200,0,0.6)" stroke-width="50" stroke-linecap="round" fill="none"/>
            <path d="M470 790 L500 850 L570 760" />
            <path d="M300 250 Q400 150 200 400" stroke="rgba(0,200,0,0.6)" stroke-width="40" stroke-linecap="round" fill="none"/>
            <path d="M480 500 Q200 650 100 850" stroke="rgba(0,200,0,0.6)" stroke-width="45" stroke-linecap="round" fill="none"/>
            <path d="M780 400 Q650 500 550 600" stroke="rgba(0,200,0,0.6)" stroke-width="35" stroke-linecap="round" fill="none"/>
            <path d="M520 750 Q650 850 900 900" stroke="rgba(0,200,0,0.6)" stroke-width="50" stroke-linecap="round" fill="none"/>
        </g>
    </svg>`);

    // ================= çŠ¶æ€ =================
    const state = {
        userImg: null,
        exemplarImg: new Image(),
        transform: { x: 0, y: 0, scale: 1.0 },
        isDragging: false,
        dragStart: { x: 0, y: 0 },
        db: null,
        userId: 'guest',
        evaluation: null
    };

    let dom = {}; // DOM å…ƒç´ ç¼“å­˜

    // ================= åˆå§‹åŒ– =================
    function init() {
        console.log("App initializing...");
        
        // 1. è·å– DOM å…ƒç´  (ç¡®ä¿å…ƒç´ å­˜åœ¨)
        dom = {
            canvas: document.getElementById('mainCanvas'),
            overlay: document.getElementById('overlay-msg'),
            uploadBtn: document.getElementById('upload-btn'),
            fileInput: document.getElementById('image-upload'),
            autoAlignBtn: document.getElementById('auto-align-btn'),
            resetBtn: document.getElementById('reset-btn'),
            saveBtn: document.getElementById('save-btn'),
            evaluateBtn: document.getElementById('evaluate-btn'),
            copyDataBtn: document.getElementById('copy-data-btn'),
            transformDebug: document.getElementById('transform-debug'),
            reportArea: document.getElementById('report-area'),
            reportContent: document.getElementById('report-content'),
            statusBox: document.getElementById('status-box'),
            styleCheckboxes: document.querySelectorAll('.style-checkbox'),
            targetChar: document.getElementById('target-char')
        };

        // 2. ç»‘å®šæ ¸å¿ƒæŒ‰é’®äº‹ä»¶ (å¢åŠ å¥å£®æ€§)
        if (dom.uploadBtn && dom.fileInput) {
            dom.uploadBtn.addEventListener('click', () => {
                console.log("ç‚¹å‡»äº†ä¸Šä¼ æŒ‰é’®");
                dom.fileInput.click();
            });
            dom.fileInput.addEventListener('change', handleFileSelect);
        } else {
            console.error("ä¸Šä¼ æŒ‰é’®æˆ–æ–‡ä»¶è¾“å…¥æ¡†æœªæ‰¾åˆ°ï¼");
        }

        if (dom.autoAlignBtn) dom.autoAlignBtn.addEventListener('click', autoAlign);
        if (dom.resetBtn) dom.resetBtn.addEventListener('click', resetTransform);
        if (dom.saveBtn) dom.saveBtn.addEventListener('click', saveToFirestore);
        if (dom.evaluateBtn) dom.evaluateBtn.addEventListener('click', generateReport);
        if (dom.copyDataBtn) dom.copyDataBtn.addEventListener('click', copyTransformData);

        // 3. åˆå§‹åŒ– Canvas
        if (dom.canvas) {
            dom.ctx = dom.canvas.getContext('2d');
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Canvas äº¤äº’
            dom.canvas.addEventListener('mousedown', startDrag);
            window.addEventListener('mousemove', onDrag);
            window.addEventListener('mouseup', endDrag);
            dom.canvas.addEventListener('wheel', onWheel);
        }

        // 4. åŠ è½½èŒƒå­—
        state.exemplarImg.src = EXEMPLAR_SVG_SRC;
        state.exemplarImg.onload = draw;

        // 5. åˆå§‹åŒ– Firebase
        initFirebase();
    }

    // ================= æ ¸å¿ƒé€»è¾‘ =================
    
    function resizeCanvas() {
        if (!dom.canvas) return;
        const parent = dom.canvas.parentElement;
        dom.canvas.width = parent.clientWidth;
        dom.canvas.height = parent.clientWidth; // æ­£æ–¹å½¢
        draw();
    }

    function handleFileSelect(e) {
        console.log("æ–‡ä»¶å·²é€‰æ‹©");
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (evt) => {
            const img = new Image();
            img.onload = () => {
                state.userImg = img;
                state.transform = { x: 0, y: 0, scale: 1.0 }; // é‡ç½®å¯¹é½
                dom.overlay.classList.add('hidden');
                setStatus("å›¾ç‰‡å·²åŠ è½½");
                draw();
            };
            img.src = evt.target.result;
        };
        reader.readAsDataURL(file);
    }

    function draw() {
        if (!dom.ctx) return;
        const ctx = dom.ctx;
        const { width, height } = dom.canvas;
        
        // æ¸…ç©º
        ctx.clearRect(0, 0, width, height);
        ctx.fillStyle = '#f9fafb';
        ctx.fillRect(0, 0, width, height);

        // ç»˜åˆ¶èŒƒå­— (åº•å±‚)
        if (state.exemplarImg.complete) {
            ctx.globalAlpha = 0.6;
            ctx.drawImage(state.exemplarImg, 0, 0, width, height);
        }

        // ç»˜åˆ¶ç”¨æˆ·å›¾ç‰‡ (ä¸Šå±‚ï¼Œå¯åŠ¨)
        if (state.userImg) {
            ctx.save();
            ctx.globalAlpha = 0.9;
            
            // å˜æ¢çŸ©é˜µ
            ctx.translate(width/2, height/2);
            ctx.translate(state.transform.x, state.transform.y);
            ctx.scale(state.transform.scale, state.transform.scale);
            
            // ç»˜åˆ¶å±…ä¸­
            const aspect = state.userImg.width / state.userImg.height;
            let drawW = width;
            let drawH = width / aspect;
            if (drawH > height) {
                drawH = height;
                drawW = height * aspect;
            }
            
            ctx.drawImage(state.userImg, -drawW/2, -drawH/2, drawW, drawH);
            ctx.restore();
        }

        // æ›´æ–°æ•°æ®å±•ç¤º
        dom.transformDebug.textContent = `Scale: ${state.transform.scale.toFixed(2)}, X: ${Math.round(state.transform.x)}, Y: ${Math.round(state.transform.y)}`;
    }

    // äº¤äº’æ“ä½œ
    function startDrag(e) {
        if (!state.userImg) return;
        state.isDragging = true;
        state.dragStart = { x: e.clientX, y: e.clientY };
        dom.canvas.style.cursor = 'grabbing';
    }

    function onDrag(e) {
        if (!state.isDragging) return;
        e.preventDefault();
        const dx = e.clientX - state.dragStart.x;
        const dy = e.clientY - state.dragStart.y;
        
        state.transform.x += dx;
        state.transform.y += dy;
        
        state.dragStart = { x: e.clientX, y: e.clientY };
        draw();
    }

    function endDrag() {
        state.isDragging = false;
        dom.canvas.style.cursor = 'move';
    }

    function onWheel(e) {
        if (!state.userImg) return;
        e.preventDefault();
        const scaleFactor = 0.05;
        if (e.deltaY < 0) {
            state.transform.scale += scaleFactor;
        } else {
            state.transform.scale = Math.max(0.1, state.transform.scale - scaleFactor);
        }
        draw();
    }

    function resetTransform() {
        state.transform = { x: 0, y: 0, scale: 1.0 };
        draw();
    }

    // ================= AI è‡ªåŠ¨å¯¹é½ =================
    async function autoAlign() {
        if (!state.userImg) {
            alert("è¯·å…ˆä¸Šä¼ ç…§ç‰‡ï¼");
            return;
        }

        setStatus("AI æ­£åœ¨è®¡ç®—æœ€ä½³å¯¹é½...");
        dom.autoAlignBtn.disabled = true;
        dom.autoAlignBtn.textContent = "ğŸ” å¯¹é½ä¸­...";

        // ç›®æ ‡å­—ç¬¦
        const targetChar = dom.targetChar.value;

        // Prompt
        const prompt = `
            Identify the bounding box of the handwritten character "${targetChar}" in this image.
            Return ONLY a JSON object with this format: {"ymin": 0, "xmin": 0, "ymax": 1000, "xmax": 1000}.
            Coordinates should be normalized to a 1000x1000 scale relative to the image dimensions.
        `;

        try {
            const imageData = dom.canvas.toDataURL("image/jpeg", 0.7).split(',')[1];

            const response = await fetch(GEMINI_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inlineData: { mimeType: "image/jpeg", data: imageData } }
                        ]
                    }],
                    generationConfig: {
                        response_mime_type: "application/json"
                    }
                })
            });

            if (!response.ok) throw new Error(`API é”™è¯¯: ${response.status}`);

            const data = await response.json();
            const textContent = data.candidates[0].content.parts[0].text.trim();
            const bbox = JSON.parse(textContent);
            
            // è®¡ç®—å˜æ¢å‚æ•°
            
            const canvasW = dom.canvas.width;
            const canvasH = dom.canvas.height;
            
            // æå– bbox ä¿¡æ¯ (åŸºäº 1000x1000)
            const boxW = (bbox.xmax - bbox.xmin) / 1000; // æ¯”ä¾‹ 0-1
            const boxH = (bbox.ymax - bbox.ymin) / 1000;
            const boxCX = (bbox.xmin + bbox.xmax) / 2 / 1000; // ä¸­å¿ƒç‚¹ X æ¯”ä¾‹
            const boxCY = (bbox.ymin + bbox.ymax) / 2 / 1000; // ä¸­å¿ƒç‚¹ Y æ¯”ä¾‹

            // å›¾ç‰‡å½“å‰åœ¨ Canvas ä¸Šçš„ç»˜åˆ¶å°ºå¯¸ (æœªå˜æ¢å‰ï¼Œå‡è®¾ scale=1, å±…ä¸­)
            const aspect = state.userImg.width / state.userImg.height;
            let drawW = canvasW;
            let drawH = canvasW / aspect;
            if (drawH > canvasH) {
                drawH = canvasH;
                drawW = canvasH * aspect;
            }

            // è®¡ç®—ä½ç§»å’Œç¼©æ”¾
            // 1. è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼šç›®æ ‡å­—ä½“çš„æœ€å¤§è¾¹é•¿å æ® Canvas çš„ 75% ç©ºé—´ï¼ˆä¸èŒƒå­—ä¿æŒä¸€è‡´ï¼‰
            const paddingRatio = 0.85; // ç›®æ ‡å æ® Canvas çš„æ¯”ä¾‹
            const sizeRatio = Math.max(boxW * drawW / canvasW, boxH * drawH / canvasH);
            const targetScale = paddingRatio / sizeRatio;

            // 2. è®¡ç®—å¹³ç§»è·ç¦»ï¼šä½¿å­—ä½“çš„ä¸­å¿ƒ (boxCX, boxCY) ç§»åŠ¨åˆ° Canvas ä¸­å¿ƒ
            const centerOffsetX = (boxCX - 0.5) * drawW;
            const centerOffsetY = (boxCY - 0.5) * drawH;
            
            // æœ€ç»ˆçš„å¹³ç§»é‡éœ€è¦åº”ç”¨ç¼©æ”¾å› å­ï¼Œå› ä¸ºå®ƒæ˜¯åœ¨ç¼©æ”¾åè¿›è¡Œä½ç§»çš„
            state.transform = {
                scale: targetScale,
                x: -centerOffsetX * targetScale,
                y: -centerOffsetY * targetScale
            };

            draw();
            setStatus("AI å¯¹é½å®Œæˆ");
            // ä¸è‡ªåŠ¨ä¿å­˜ï¼Œè®©ç”¨æˆ·å†³å®šæ˜¯å¦ä¿å­˜
        } catch (error) {
            console.error("AI å¯¹é½å¤±è´¥:", error);
            setStatus("å¯¹é½å¤±è´¥ (è¯·ç¡®ä¿å›¾ç‰‡ä¸­åªæœ‰ç›®æ ‡å­—ç¬¦ï¼Œå¹¶æ‰‹åŠ¨è°ƒæ•´)");
        } finally {
            dom.autoAlignBtn.disabled = false;
            dom.autoAlignBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                ğŸ¯ AI è‡ªåŠ¨å¯¹é½
            `;
        }
    }

    // ================= AI è¯„ä¼° =================
    async function generateReport() {
        if (!state.userImg) {
            alert("è¯·å…ˆä¸Šä¼ ç…§ç‰‡ï¼");
            return;
        }

        setStatus("æ­£åœ¨ç”Ÿæˆè¯„ä¼°æŠ¥å‘Š...");
        dom.evaluateBtn.disabled = true;
        dom.evaluateBtn.textContent = "AI æ€è€ƒä¸­...";
        dom.reportArea.classList.remove('hidden');
        dom.reportContent.innerHTML = '<div class="animate-pulse text-gray-500">æ­£åœ¨åˆ†æç¬”ç”»ä¸ç»“æ„...</div>';

        const styles = Array.from(dom.styleCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        
        const targetChar = dom.targetChar.value;

        const prompt = `
            ä½ æ˜¯ä¸€ä½ç¡¬ç¬”ä¹¦æ³•ä¸“å®¶ã€‚ç”¨æˆ·ä¸Šä¼ äº†ä¸€å¼ æ‰‹å†™çš„â€œ${targetChar}â€å­—å›¾ç‰‡ã€‚
            è¯·æ ¹æ®ä»¥ä¸‹é€‰å®šçš„é£æ ¼æ ‡å‡†è¿›è¡Œè¯„ä¼°ï¼š${styles.join('ã€')}ã€‚
            
            è¯·è¾“å‡ºä¸€ä»½è¯„ä¼°æŠ¥å‘Šï¼ˆMarkdownæ ¼å¼ï¼‰ï¼ŒåŒ…å«ï¼š
            1. **æ€»ä½“è¯„åˆ†** (0-100åˆ†)ã€‚
            2. **é£æ ¼å¥‘åˆåº¦åˆ†æ**ï¼šé’ˆå¯¹é€‰å®šçš„é£æ ¼ï¼Œåˆ†æç”¨æˆ·å­—è¿¹æ˜¯å¦ç¬¦åˆå…¶ç‰¹å¾ï¼ˆå¦‚ç”°è‹±ç« çš„è§„èŒƒã€å¢ä¸­å—çš„é›„æµ‘ï¼‰ã€‚
            3. **ç¬”ç”»ä¸ç»“æ„ç‚¹è¯„**ï¼šæŒ‡å‡ºå…·ä½“çš„ä¼˜ç‚¹å’Œéœ€è¦æ”¹è¿›çš„ç¬”ç”»ã€‚
            4. **æ”¹è¿›å»ºè®®**ï¼šç»™å‡ºå…·ä½“çš„ç»ƒä¹ æŒ‡å¯¼ã€‚
        `;

        try {
            const imageData = dom.canvas.toDataURL("image/jpeg", 0.7).split(',')[1];

            const response = await fetch(GEMINI_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inlineData: { mimeType: "image/jpeg", data: imageData } }
                        ]
                    }]
                })
            });

            if (!response.ok) {
                if (response.status === 401) throw new Error("API å¯†é’¥é”™è¯¯ (401)");
                throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status}`);
            }

            const data = await response.json();
            const text = data.candidates[0].content.parts[0].text;
            
            dom.reportContent.innerHTML = text
                .replace(/^# (.*$)/gim, '<h3 class="text-xl font-bold mb-2">$1</h3>')
                .replace(/^## (.*$)/gim, '<h4 class="text-lg font-bold mt-3 mb-1 text-indigo-700">$1</h4>')
                .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
                .replace(/\n/gim, '<br>');
            
            setStatus("æŠ¥å‘Šç”Ÿæˆå®Œæ¯•");

        } catch (error) {
            console.error(error);
            dom.reportContent.innerHTML = `
                <div class="p-4 bg-yellow-50 text-yellow-800 rounded">
                    <strong>API è¿æ¥å—é™ï¼Œæ˜¾ç¤ºæ¨¡æ‹ŸæŠ¥å‘Šï¼š</strong><br><br>
                    <strong>æ€»ä½“è¯„åˆ†ï¼š</strong> 85åˆ†<br>
                    <strong>é£æ ¼åˆ†æï¼š</strong> æ‚¨çš„å­—è¿¹ç»“æ„å·¥æ•´ï¼Œé¢‡æœ‰${styles[0] || 'æ¥·ä¹¦'}çš„é£éª¨ã€‚é‡å¿ƒå¹³ç¨³ï¼Œä¸­å®«æ”¶ç´§åšå¾—ä¸é”™ã€‚<br>
                    <strong>æ”¹è¿›å»ºè®®ï¼š</strong> â€œ${targetChar}â€å­—çš„æºç”»å¯ä»¥æ›´èˆ’å±•ä¸€äº›ï¼Œæ³¨æ„èµ·ç¬”çš„è—é”‹ç»†èŠ‚ã€‚
                </div>
            `;
            setStatus("æ˜¾ç¤ºæ¨¡æ‹ŸæŠ¥å‘Š");
        } finally {
            dom.evaluateBtn.disabled = false;
            dom.evaluateBtn.textContent = "âœ¨ ç”Ÿæˆè¯„ä¼°æŠ¥å‘Š";
        }
    }

    // ================= è¾…åŠ©åŠŸèƒ½ =================
    function setStatus(msg) {
        dom.statusBox.textContent = `çŠ¶æ€: ${msg}`;
    }

    function copyTransformData() {
        const data = JSON.stringify(state.transform, null, 2);
        const textArea = document.createElement('textarea');
        textArea.value = data;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            alert("å¯¹é½æ•°æ®å·²å¤åˆ¶ï¼");
        } catch (err) {
            console.error('Copy failed', err);
        }
        document.body.removeChild(textArea);
    }

    async function initFirebase() {
        try {
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            if (!Object.keys(firebaseConfig).length) return;
            
            const app = firebase.initializeApp(firebaseConfig);
            state.db = firebase.getFirestore(app);
            const auth = firebase.getAuth(app);
            
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await firebase.signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await firebase.signInAnonymously(auth);
            }
            
            state.userId = auth.currentUser?.uid;
            // ç•Œé¢ä¸Šæ²¡æœ‰æ˜¾ç¤ºè®¤è¯ä¿¡æ¯ï¼Œæ­¤å¤„åªåœ¨æ§åˆ¶å°è®°å½•
            
            if (state.userId) loadFromFirestore();

        } catch (e) {
            console.error("Firebase Error", e);
        }
    }

    async function saveToFirestore() {
        if (!state.db || !state.userId) {
            // ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ€æ¡†æˆ–åœ¨çŠ¶æ€æ æ˜¾ç¤ºä¿¡æ¯æ›¿ä»£ alert
            setStatus("æœªè¿æ¥åˆ°äº‘æ•°æ®åº“ï¼Œæ— æ³•ä¿å­˜");
            return;
        }
        try {
            await firebase.setDoc(firebase.doc(state.db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'app'}/users/${state.userId}/data/session`), {
                transform: state.transform,
                styles: Array.from(dom.styleCheckboxes).filter(cb => cb.checked).map(cb => cb.value),
                timestamp: new Date()
            }, { merge: true });
            setStatus("è¿›åº¦å·²ä¿å­˜åˆ°äº‘ç«¯");
        } catch (e) {
            console.error(e);
            setStatus("ä¿å­˜å¤±è´¥");
        }
    }

    async function loadFromFirestore() {
        // ç®€åŒ–åŠ è½½é€»è¾‘...
    }

    // å¯åŠ¨
    window.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>